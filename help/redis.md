Разберем **Redis** и **Redis Sentinel** детально. Основное внимание уделим конфигурациям и мониторингу.

---

## 1. **Redis Configuration (`redis-node1.conf`)**

Это основной файл конфигурации Redis для узла `redis-node1`. Вот пример, что мы использовали:

```conf
port 6379
replica-announce-ip redis-node1
protected-mode no
replicaof redis-node2 6379
```

### Разбор параметров:

1. **`port 6379`**  
   Указывает, на каком порту Redis будет принимать подключения.  
   - Значение по умолчанию: `6379`.
   - Узлы кластера используют этот порт для общения друг с другом.

2. **`replica-announce-ip redis-node1`**  
   Указывает IP-адрес или хостнейм, который узел объявляет для подключения другим узлам (например, мастеру).  
   Используется при репликации, чтобы сообщить другим узлам, где они могут найти этот узел.

3. **`protected-mode no`**  
   Отключает защищённый режим.  
   - В защищённом режиме Redis отклоняет все подключения, кроме тех, что идут с localhost.  
   - `no` используется, чтобы узел был доступен другим контейнерам в сети.

4. **`replicaof redis-node2 6379`**  
   Указывает, что данный узел является репликой (слейвом) другого узла (`redis-node2`) на порту `6379`.  
   - Реплика будет автоматически синхронизировать данные с мастером.

---

### Конфигурации других узлов

- **Для `redis-node2.conf`:**
  ```conf
  port 6379
  replica-announce-ip redis-node2
  protected-mode no
  replicaof redis-node1 6379
  ```

- **Для `redis-node3.conf`:**
  ```conf
  port 6379
  replica-announce-ip redis-node3
  protected-mode no
  replicaof redis-node1 6379
  ```

Эти настройки создают круговую репликацию. Если мастер (например, `redis-node1`) выходит из строя, Sentinel может выбрать нового мастера, а остальные узлы синхронизируются с ним.

---

## 2. **Redis Sentinel Configuration (`sentinel-node1.conf`)**

Файл для Sentinel. Его задача — мониторить Redis-узлы, управлять репликацией и автоматически переключать мастера в случае сбоя.

```conf
port 26379
sentinel monitor mymaster redis-node1 6379 2
sentinel down-after-milliseconds mymaster 5000
sentinel failover-timeout mymaster 10000
sentinel parallel-syncs mymaster 1
```

### Разбор параметров:

1. **`port 26379`**  
   Указывает порт, на котором Sentinel принимает запросы.  
   - Значение по умолчанию: `26379`.

2. **`sentinel monitor mymaster redis-node1 6379 2`**  
   Настраивает Sentinel для мониторинга мастера Redis.  
   - `mymaster`: имя мастера, под которым он будет отслеживаться.  
   - `redis-node1 6379`: адрес мастера.  
   - `2`: минимальное количество Sentinel-узлов, которые должны подтвердить сбой мастера, чтобы инициировать failover.

3. **`sentinel down-after-milliseconds mymaster 5000`**  
   Указывает, через какое время (в миллисекундах) Sentinel решит, что мастер недоступен.  
   - Здесь: 5 секунд.

4. **`sentinel failover-timeout mymaster 10000`**  
   Указывает тайм-аут для операции failover (переключения мастера).  
   - Здесь: 10 секунд.  
   - Это включает в себя выбор нового мастера и его синхронизацию с репликами.

5. **`sentinel parallel-syncs mymaster 1`**  
   Указывает, сколько реплик можно одновременно синхронизировать с новым мастером.  
   - Здесь: 1 реплика за раз.

---

### Sentinel для других узлов

- Конфигурации `sentinel-node2.conf` и `sentinel-node3.conf` будут идентичными, но хост для мониторинга (`redis-node1`) будет одинаковым, так как все Sentinel-узлы наблюдают за одним мастером.

---

## 3. **Мониторинг Redis Sentinel**

Sentinel **не конфликтует** с Prometheus и Grafana, так как они выполняют разные задачи:

1. **Sentinel:**
   - Управляет отказоустойчивостью Redis (переключение мастера, отслеживание состояния).
   - Его основная цель — обеспечить высокую доступность Redis.

2. **Prometheus + Grafana:**
   - Отвечают за сбор, хранение и визуализацию метрик.
   - Prometheus может мониторить как Redis (через экспортёр метрик), так и сам Sentinel.

---

### Интеграция Prometheus для мониторинга Redis

1. Установите Redis Exporter:
   ```yaml
   redis-exporter:
     image: oliver006/redis_exporter:latest
     container_name: redis_exporter
     environment:
       REDIS_ADDR: redis-node1:6379
     ports:
       - "9121:9121"
     networks:
       - db_network
   ```

2. Включите метрики Sentinel:
   Sentinel из коробки не поддерживает Prometheus, но вы можете написать простой скрипт, который выгружает данные Sentinel (`INFO`) и преобразует их в метрики.

---

### Почему важно использовать оба подхода?

- **Sentinel**: обеспечивает управление Redis-кластером.
- **Prometheus и Grafana**: позволяют вам наблюдать за производительностью Redis и Sentinel.

---

Технически, **одного Redis Sentinel достаточно**, чтобы отслеживать состояние мастера и управлять фейловерами. Однако в реальных сценариях используется **несколько Sentinel-ов**. Вот почему:

---

## 1. **Высокая доступность и отказоустойчивость Sentinel**

- Если у вас только один Sentinel, и он выходит из строя, система теряет способность переключать мастера в случае его сбоя.
- С несколькими Sentinel-ами (обычно **не менее трёх**) вероятность того, что система останется работоспособной, значительно выше.

### Пример: 3 Sentinel-а
- Если один Sentinel падает, два оставшихся могут продолжить работу.
- Для принятия решения о сбое мастера (например, для фейловера) используется **кворум**.  
  Например, настройка `sentinel monitor mymaster redis-node1 6379 2` требует кворума из 2-х Sentinel-ов. Это означает, что хотя бы два Sentinel-а должны подтвердить, что мастер недоступен.

---

## 2. **Кворум и консистентность**

Redis Sentinel использует механизм кворума для принятия решений:
- **Кворум** — это минимальное количество Sentinel-ов, которые должны согласиться с тем, что мастер недоступен, чтобы инициировать фейловер.
- **Зачем это нужно?**
  - Один Sentinel может ошибочно считать мастер недоступным (например, из-за сетевой задержки или временного сбоя).
  - Кворум помогает избежать ложных срабатываний.

В нашем примере настройка `2` в `sentinel monitor mymaster` требует, чтобы как минимум два Sentinel-а подтвердили сбой мастера.  
Если у вас только один Sentinel, фейловер произойдёт при любой временной проблеме, что может привести к ненужному переключению мастера.

---

## 3. **Распределение нагрузки**

- Sentinel также обрабатывает клиентские запросы (например, узнаёт, какой узел сейчас мастер).
- С несколькими Sentinel-ами нагрузка распределяется между ними, улучшая производительность.

---

## 4. **Лучшие практики: Почему 3 Sentinel-а, а не 2 или 5?**

- **2 Sentinel-а**:  
  При кворуме `2` нет избыточности — сбой одного Sentinel-а делает систему недееспособной.  
  Для кворума `1` система становится ненадёжной (фейловер срабатывает при любом сбое).

- **3 Sentinel-а**:  
  Это минимальная конфигурация, обеспечивающая баланс между отказоустойчивостью и сложностью.  
  - Кворум можно настроить на `2`.
  - Один Sentinel может выйти из строя, но два других продолжат работу.

- **5 или больше Sentinel-ов**:  
  Используется в крупных системах. Но в большинстве случаев это избыточно и усложняет управление.

---

## 5. **Можно ли использовать один Sentinel?**

Да, если:
- Это тестовая или небольшая система.
- Отказоустойчивость не является критической.  

Однако это **не рекомендуется для продакшн-среды**.

---

## Итог

- В нашем случае 3 Redis Sentinel-а обеспечивают надёжную систему, соответствующую лучшим практикам.
- Вы можете настроить минимальный кворум `2` для повышения стабильности.
- Если у вас тестовый проект, одного Sentinel-а достаточно, но стоит помнить о рисках.

