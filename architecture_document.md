# Архитектура Pastebin-клона

## 1. Общая архитектура

### Описание
Сервис предназначен для хранения текстовых блоков с временным сроком жизни (TTL). Пользователь может создать текст, получить уникальную ссылку и поделиться ею. После истечения срока текст автоматически удаляется из системы.

### Схема проекта:
![graf](https://github.com/user-attachments/assets/4ec32716-62e0-4e55-9abb-0115e3007538)

### Компоненты
1. **Api-servise** (FastAPI):
   - Отвечает за обработку запросов пользователей.
   - Сохраняет данные постов в Postgres.
   - Отправляет сообщение с TTL удаления в RabbitMQ.

3. **Hash-service** (FastAPI):
   - Отвечает за актуальные хэш-ключи.
   - Берет уникальные ключи из Redis.
   - Проверяет и наполняет уникальным хэшем Redis из бд.
   - Преобразует последовательность sequence из PostgreSQL в уникальный короткий хэш-ключ.

4. **Redis-hash**:
   - Хранит уникальные хэш-ключи для быстрого получения.
  
5. **Postgres-hash**:
   - Имеет извлекаемую последовательность sequence, которая используется для коротких хэшей.

6. **Redis-text**:
   - Кеширует посты пользователей срок TTL которых < часа.
   - Кеширует запрошеные посты пользователями на 10 минут для быстрого доступа.
  
7. **Postgres-text**:
   - Хранит пользовательские посты, их TTL и дату создания.

8. **Брокер сообщений** (RabbitMQ):
   - Установлен плагин для работы с отложенными сообщениями.
   - Получает сообщения с хэшем и TTL, для задачи на удаление.
  
9. **Worker** (FastAPI):
    - Читает брокер сообщений.
    - Исполняет удаление постов из Postgres-text по их TTL.

8. **Мониторинг (Prometheus + Grafana)**:
   - Сбор метрик по API.
   - Визуализация данных.

---

## 2. Поток данных

### 2.1 Создание текста
1. Пользователь отправляет текст и TTL через API.
2. API вызывает хэш-генератор для создания уникального идентификатора.
3. Сервис сохраняет текст в PostgreSQL.
4. Возвращается уникальная ссылка (например, `https://example.com/<hash>`).

### 2.2 Запрос текста по ссылке
1. Пользователь отправляет запрос по короткой ссылке (`/<hash>`).
2. API проверяет кэш (Redis):
   - Если текст есть в кэше, он возвращается сразу.
   - Если текста нет, API загружает данные из PostgreSQL, кэширует их в Redis и возвращает пользователю.

### 2.3 Удаление истёкших данных
1. Worker читает RabbitMQ на задачи.
2. Для каждой истёкшей записи:
   - Текст удаляется из PostgreSQL.

---

## 3. Масштабирование и отказоустойчивость

### Горизонтальное масштабирование
- **Load balancer:** добавление в архитектуру NGINX.
- **API:** добавление новых инстансов за Load Balancer.
- **Redis:** кластеризация Redis для высокой нагрузки.
- **PostgreSQL:** настройка реплик для чтения.

### Автоматическое восстановление
- Использование оркестраторов (например, Kubernetes) для автоматического перезапуска упавших контейнеров.

---

