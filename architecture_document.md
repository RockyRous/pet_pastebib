# Архитектура Pastebin-клона

## 1. Общая архитектура

### Описание
Сервис предназначен для хранения текстовых блоков с временным сроком жизни (TTL). Пользователь может создать текст, получить уникальную ссылку и поделиться ею. После истечения срока текст автоматически удаляется из системы.

### Компоненты
1. **Load Balancer (NGINX)**:
   - Распределяет входящие запросы между экземплярами API-сервиса.
   - Обеспечивает отказоустойчивость и балансировку нагрузки.

2. **API-сервис** (FastAPI):
   - Отвечает за обработку запросов пользователей.
   - Подключается к Redis, PostgreSQL и Google Cloud Storage.

3. **Хэш-генератор**:
   - Генерирует уникальные и короткие хэши (Base64).
   - Проверяет уникальность в PostgreSQL.

4. **Кэш (Redis)**:
   - Хранит популярные посты для быстрого доступа.
   - Кэширует метаданные текстов.

5. **Хранилище данных (Google Cloud Storage)**:
   - Основное место для хранения текстов.

6. **База данных (PostgreSQL)**:
   - Хранит метаданные: ссылки, TTL, статистику запросов.

7. **Планировщик задач (Celery)**:
   - Выполняет фоновые задачи:
     - Очистка истёкших данных.
     - Очистка кэша Redis.
     - Сбор статистики.

8. **Мониторинг (Prometheus + Grafana)**:
   - Сбор метрик по API, кэшу, базе данных и Celery.
   - Визуализация данных.

---

## 2. Поток данных

### 2.1 Создание текста
1. Пользователь отправляет текст и TTL через API.
2. API вызывает хэш-генератор для создания уникального идентификатора.
3. Сервис сохраняет текст в Google Cloud Storage.
4. Метаданные (хэш, TTL, путь к тексту) записываются в PostgreSQL.
5. Возвращается уникальная ссылка (например, `https://example.com/<hash>`).

### 2.2 Запрос текста по ссылке
1. Пользователь отправляет запрос по короткой ссылке (`/<hash>`).
2. API проверяет кэш (Redis):
   - Если текст есть в кэше, он возвращается сразу.
   - Если текста нет, API загружает данные из Google Cloud Storage, кэширует их в Redis и возвращает пользователю.

### 2.3 Удаление истёкших данных
1. Celery сканирует PostgreSQL на истёкшие записи.
2. Для каждой истёкшей записи:
   - Текст удаляется из Google Cloud Storage.
   - Метаданные удаляются из PostgreSQL.
   - Соответствующий кэш удаляется из Redis.

---

## 3. Технические детали

### 3.1 Load Balancer (NGINX)
- **Роль:** распределение запросов между экземплярами API-сервиса.


### 3.2 API-сервис (FastAPI)
- **Функции:**
  - Создание текста.
  - Получение текста по ссылке.
  - Удаление текста (фоново через Celery).

### 3.3 Хэш-генератор
- Генерация уникального хэша (Base64):

### 3.4 Redis
- **Кэш популярных постов:**
  - Ключ: `popular:<hash>`.
  - TTL: 24 часа.
- **Кэш метаданных:**
  - Ключ: `meta:<hash>`.
  - TTL: 1 час.

### 3.5 Celery
- **Задачи:**
  1. Очистка истёкших данных:

  2. Сбор статистики (популярные посты).

### 3.6 Мониторинг (Prometheus + Grafana)
- **Prometheus:** сбор метрик.
- **Grafana:** визуализация.
- **Метрики для мониторинга:**
  - **API-сервис:** время обработки запросов, частота ошибок.
  - **Redis:** хиты кэша, использование памяти.
  - **PostgreSQL:** активные соединения, задержка запросов.
  - **Celery:** количество задач в очереди.


---

## 4. Масштабирование и отказоустойчивость

### Горизонтальное масштабирование
- **API:** добавление новых инстансов за Load Balancer.
- **Redis:** кластеризация Redis для высокой нагрузки.
- **PostgreSQL:** настройка реплик для чтения.

### Автоматическое восстановление
- Использование оркестраторов (например, Kubernetes) для автоматического перезапуска упавших контейнеров.

---

## 5. Используемые технологии

| Компонент           | Технология                   |
|---------------------|------------------------------|
| API-сервис          | FastAPI                     |
| Хэш-генератор       | Python (Base64)             |
| Кэш                 | Redis                       |
| Хранилище данных    | Google Cloud Storage        |
| База данных         | PostgreSQL                  |
| Балансировка        | NGINX                       |
| Планировщик задач   | Celery                      |
| Мониторинг          | Prometheus + Grafana        |

---

## 6. Пример потока данных

1. Пользователь отправляет текст на `/create`.
2. API вызывает хэш-генератор и сохраняет текст в Google Cloud Storage.
3. Метаданные записываются в PostgreSQL.
4. Пользователь получает короткую ссылку.

5. При запросе по ссылке `/hash` API сначала проверяет Redis. Если данных нет, текст загружается из Google Cloud Storage.

6. Celery регулярно удаляет устаревшие данные из хранилища и базы данных.
